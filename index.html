<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hitscan Gaming Mouse Driver</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bgDark: '#0a0a0a',
                        panelDark: '#141414',
                        inputDark: '#1a1a1a',
                        borderDark: '#2a2a2a',
                        accent: '#ffffff',
                        textGray: '#888888',
                        statusSuccess: '#34d399', // Emerald 400
                        statusDanger: '#f87171',  // Red 400
                        statusInfo: '#60a5fa',    // Blue 400
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom scrollbar and range slider styles */
        body {
            background-color: #000;
            color: white;
        }

        /* Range slider thumb style */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Custom animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // -----------------------------------------------------------------------------
        // WebHID Service (Nordic HID Protocol Implementation)
        // -----------------------------------------------------------------------------

        const REPORT_ID = 6;
        const REPORT_USER_CONFIG_SIZE = 13;
        const REPORT_SIZE = 1 + REPORT_USER_CONFIG_SIZE; // 1 byte ID + 29 bytes Payload
        const VENDOR_ID = 0x1915; // Target Vendor ID

        const ConfigStatus = {
            PENDING: 0,
            GET_MAX_MOD_ID: 1,
            GET_HWID: 2,
            GET_BOARD_NAME: 3,
            INDEX_PEERS: 4,
            GET_PEER: 5,
            SET: 6,
            FETCH: 7,
            SUCCESS: 8,
            TIMEOUT: 9,
            REJECT: 10,
            WRITE_FAIL: 11,
            DISCONNECTED: 12,
            GET_PEERS_CACHE: 13,
            FAULT: 99
        };

        // Configuration Map - Matching the Python logs
        const HARDCODED_CONFIG = {
            "battery_meas": {
                id: 0,
                options: {
                    "bat_level": 1
                }
            },
            "motion/paw3395": {
                id: 1,
                options: {
                    "module_variant": 1,
                    "cpi": 2,
                    "downshift": 3,
                    "rest1": 4,
                    "rest2": 5,
                    "cpi_stage_1": 6,
                    "cpi_stage_2": 7,
                    "cpi_stage_3": 8,
                    "cpi_stage_4": 9,
                    "cpi_stage_active": 10,
                    "poll_esb": 11,
                    "poll_usb": 12,
                    "ripple_control": 13,
                    "angle_snap": 14,
                    "lod": 15
                }
            },
            "ble_bond": {
                id: 2,
                options: {
                    "peer_erase": 1,
                    "peer_search": 2
                }
            }
        };

        const WebHIDService = {
            device: null,
            configMap: HARDCODED_CONFIG,
            isConnecting: false,

            cleanString(str) {
                // Remove null bytes and non-printable characters
                // Python: .decode('utf-8', errors='replace').replace(chr(0x00), '')
                return str.replace(/\0/g, '').replace(/[^\x20-\x7E]/g, '').trim();
            },

            toHexString(buffer) {
                return Array.from(new Uint8Array(buffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            },

            // Connect via User Gesture
            async connect() {
                if (!navigator.hid) throw new Error('WebHID not supported in this browser.');

                const devices = await navigator.hid.requestDevice({ filters: [{ vendorId: VENDOR_ID }] });
                if (devices.length === 0) throw new Error('No device selected');

                this.device = devices[0];
                if (!this.device.opened) await this.device.open();

                console.log(`[HID] Connected to ${this.device.productName} (PID: 0x${this.device.productId.toString(16)})`);

                // Determine if Dongle based on PID range (0xF***)
                // Mouse is 0xE***, Dongle is 0xF***
                const isDongle = (this.device.productId & 0xF000) === 0xF000;
                console.log(`[HID] Device Type: ${isDongle ? 'Wireless Dongle' : 'Wired Mouse'}`);

                return { device: this.device, isDongle };
            },

            // Check for already paired devices (for polling)
            async checkConnection() {
                if (!navigator.hid) return null;
                if (this.device && this.device.opened) {
                    return {
                        device: this.device,
                        isDongle: (this.device.productId & 0xF000) === 0xF000
                    };
                }

                const devices = await navigator.hid.getDevices();
                const pairedDevice = devices.find(d => d.vendorId === VENDOR_ID);

                if (pairedDevice) {
                    try {
                        if (!pairedDevice.opened) await pairedDevice.open();
                        this.device = pairedDevice;
                        console.log(`[HID] Reconnected to ${pairedDevice.productName} (PID: 0x${pairedDevice.productId.toString(16)})`);
                        const isDongle = (pairedDevice.productId & 0xF000) === 0xF000;
                        return { device: this.device, isDongle };
                    } catch (e) {
                        console.warn(`[HID] Failed to open paired device: ${e.message}`);
                    }
                }
                return null;
            },

            async disconnect() {
                if (this.device && this.device.opened) await this.device.close();
                this.device = null;
            },

            // Core Protocol Handler
            async exchangeFeatureReport(recipient, eventId, status, data = null) {
                if (!this.device || !this.device.opened) throw new Error('Device not connected');

                const buffer = new Uint8Array(REPORT_USER_CONFIG_SIZE);
                buffer[0] = recipient;
                buffer[1] = eventId;
                buffer[2] = status;
                buffer[3] = data ? data.byteLength : 0;

                if (data) {
                    if (data.byteLength > 25) throw new Error('Data too long for HID report');
                    buffer.set(new Uint8Array(data), 4);
                }

                console.log(`[HID] Sending: ID=${REPORT_ID} event=${eventId} Payload=${this.toHexString(buffer)}`);

                try {
                    // Python sends [ID, Rcpt, Evt, Stat, Len, Data...]
                    // WebHID sendFeatureReport takes ID as arg1, and Payload as arg2.
                    // Payload = [Rcpt, Evt, Stat, Len, Data...]
                    await this.device.sendFeatureReport(REPORT_ID, buffer);
                } catch (e) {
                    console.error("[HID] Send Error:", e);
                    throw e;
                }

                // Python: POLL_INTERVAL_DEFAULT = 0.02, POLL_RETRY_COUNT = 200 => 4 seconds
                const MAX_RETRIES = 100;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    await new Promise(r => setTimeout(r, 20)); // 100ms poll interval

                    try {
                        const view = await this.device.receiveFeatureReport(REPORT_ID);

                        // --- DEBUG: Print Raw Data ---
                        if (view && view.buffer) {
                            console.log(`[HID] RAW DATA: ${this.toHexString(view.buffer)}`);
                        }

                        if (!view || !(view instanceof DataView)) continue;

                        // HANDLE OFFSET: Check if the first byte is the Report ID (6)
                        // This fixes the "Mismatch: Expected 0/6, Got 6/0" error.
                        let offset = 0;
                        if (view.byteLength === REPORT_SIZE && view.getUint8(0) === REPORT_ID) {
                            offset = 1;
                        }

                        // Ensure we have enough data (header size is 4 bytes + offset)
                        if (view.byteLength < 4 + offset) continue;

                        const r_rcpt = view.getUint8(0 + offset);
                        const r_evt = view.getUint8(1 + offset);
                        const r_stat = view.getUint8(2 + offset);
                        const r_len = view.getUint8(3 + offset);

                        // Detailed logging for debugging
                        if (r_stat !== ConfigStatus.PENDING || i % 20 === 0) {
                            console.log(`[HID] Poll ${i}: Rcpt=${r_rcpt}, Evt=${r_evt}, Stat=${r_stat} (Offset=${offset})`);
                        }

                        if (r_stat === ConfigStatus.PENDING) continue;

                        if (r_rcpt === recipient && r_evt === eventId) {
                            if (r_stat === ConfigStatus.SUCCESS) {
                                // Data starts at offset 4
                                return new Uint8Array(view.buffer, view.byteOffset + 4 + offset, r_len);
                            }
                            console.warn(`[HID] Protocol Status Error: ${r_stat}`);
                            return null;
                        } else {
                            // Only log mismatch if it's not a pending packet
                            console.warn(`[HID] Mismatch: Expected ${recipient}/${eventId}, Got ${r_rcpt}/${r_evt}`);
                        }
                    } catch (e) {
                        // Ignore read errors during polling (device might not be ready)
                        // console.warn(`[HID] Poll ${i} Error:`, e);
                    }
                }
                console.warn('[HID] Timeout waiting for response');
                return null;
            },

            async getBoardName() {
                const result = await this.exchangeFeatureReport(0, 0, ConfigStatus.GET_BOARD_NAME);
                if (result) {
                    const textDecoder = new TextDecoder('utf-8');
                    return this.cleanString(textDecoder.decode(result));
                }
                return null;
            },

            async getHWID() {
                const result = await this.exchangeFeatureReport(0, 0, ConfigStatus.GET_HWID);
                if (result) {
                    return this.toHexString(result);
                }
                return null;
            },

            // Helper to get configuration value
            async getConfig(moduleName, optionName) {
                const availableModules = Object.keys(this.configMap);
                const mod = availableModules.find(k => k.includes(moduleName));
                if (!mod) return null;

                const modInfo = this.configMap[mod];
                let optId = modInfo.options[optionName];
                if (optId === undefined) return null;

                const eventId = (modInfo.id << 4) | optId;
                const result = await this.exchangeFeatureReport(0, eventId, ConfigStatus.FETCH);

                if (result) {
                    const view = new DataView(result.buffer, result.byteOffset, result.byteLength);
                    if (result.byteLength === 4) return view.getUint32(0, true);
                    if (result.byteLength === 1) return view.getUint8(0);
                    if (result.byteLength === 2) return view.getUint16(0, true);
                }
                return null;
            },

            // Helper to set configuration value
            async setConfig(moduleName, optionName, value) {
                const availableModules = Object.keys(this.configMap);
                const mod = availableModules.find(k => k.includes(moduleName));
                if (!mod) throw new Error(`Module ${moduleName} not found`);

                const modInfo = this.configMap[mod];
                const optId = modInfo.options[optionName];
                if (optId === undefined) throw new Error(`Option ${optionName} not found`);

                const eventId = (modInfo.id << 4) | optId;
                const data = new ArrayBuffer(4);
                new DataView(data).setUint32(0, value, true); // Little endian

                const resp = await this.exchangeFeatureReport(0, eventId, ConfigStatus.SET, data);
                return !!resp;
            },

            async startPairing() {
                if (!this.device || !this.device.opened) throw new Error('Device not connected');
                const buffer = new Uint8Array(REPORT_USER_CONFIG_SIZE);
                buffer[0] = 1;  // Recipient
                buffer[1] = 0;     // Event ID
                buffer[2] = ConfigStatus.SET;      // Status
                buffer[3] = 0; // Data length

                console.log(`[HID] Sending Pairing Request: ID=${REPORT_ID}`);
                try {
                    await this.device.sendFeatureReport(REPORT_ID, buffer);
                    console.log("[HID] Pairing Request Sent");
                    return true;
                } catch (e) {
                    console.error("[HID] Pairing Request Error:", e);
                    throw e;
                }
            }
        };


        // -----------------------------------------------------------------------------
        // SVG Icons
        // -----------------------------------------------------------------------------
        const Icons = {
            Settings: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></svg>,
            Minus: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12" /></svg>,
            X: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></svg>,
            ChevronDown: ({ size = 14 }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9" /></svg>,
            Battery: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="#34d399" stroke="#34d399" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="6" width="18" height="12" rx="2" ry="2" /><line x1="23" y1="13" x2="23" y2="11" /></svg>,
            Download: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>,
            Upload: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></svg>,
            RotateCcw: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6" /><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10" /></svg>,
            Usb: ({ isConnected }) => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke={isConnected ? 'white' : 'currentColor'} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={isConnected ? 'text-white' : 'text-gray-500'}><path d="M10 20v-4" /><path d="M14 10v4" /><path d="M18 10v4" /><path d="M6 10v4" /><circle cx="12" cy="12" r="3" /><path d="M12 7V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v3" /><path d="M12 17v3a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3" /></svg>,
            Wireless: () => (
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                    <circle cx="12" cy="12" r="1.5" fill="currentColor" />
                    <path d="M17.5 7.5a7 7 0 0 1 0 9" />
                    <path d="M6.5 7.5a7 7 0 0 0 0 9" />
                    <path d="M21 4a12 12 0 0 1 0 16" opacity="0.4" />
                    <path d="M3 4a12 12 0 0 0 0 16" opacity="0.4" />
                </svg>
            ),
        };

        // -----------------------------------------------------------------------------
        // UI Components
        // -----------------------------------------------------------------------------

        const ToggleSwitch = ({ checked, onChange }) => (
            <button
                onClick={() => onChange(!checked)}
                className={`w-10 h-5 rounded-full relative transition-colors duration-200 focus:outline-none ${checked ? 'bg-white' : 'bg-gray-600'
                    }`}
            >
                <div
                    className={`absolute top-0.5 left-0.5 w-4 h-4 rounded-full bg-black shadow-md transform transition-transform duration-200 ${checked ? 'translate-x-5' : 'translate-x-0'
                        }`}
                />
            </button>
        );

        const CustomSelect = ({ value, options, onChange, width = "w-full" }) => (
            <div className={`relative group ${width}`}>
                <select
                    value={value}
                    onChange={(e) => onChange(e.target.value)}
                    className="w-full appearance-none bg-inputDark text-gray-200 text-xs border border-gray-700 rounded px-3 py-2 pr-8 focus:outline-none focus:border-gray-500 cursor-pointer hover:border-gray-600"
                >
                    {options.map((opt) => (
                        <option key={opt} value={opt}>
                            {opt}
                        </option>
                    ))}
                </select>
                <div className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-500 pointer-events-none">
                    <Icons.ChevronDown />
                </div>
            </div>
        );

        const RadioGroup = ({ options, selected, onChange, label, layout = "horizontal" }) => (
            <div className="flex flex-col gap-2">
                {label && <span className="text-gray-400 text-xs font-bold mb-2 block">{label}</span>}
                <div className={`flex ${layout === "horizontal" ? "gap-8" : "gap-4"}`}>
                    {options.map((opt) => (
                        <label key={opt} className="flex flex-col items-center gap-2 cursor-pointer group">
                            <div className="relative flex items-center justify-center">
                                <input
                                    type="radio"
                                    className="peer appearance-none w-4 h-4 border-2 border-gray-500 rounded-full checked:border-white checked:bg-transparent transition-all"
                                    checked={String(selected) === String(opt)}
                                    onChange={() => onChange(opt)}
                                />
                                <div className={`absolute w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity`}></div>
                            </div>
                            <span className={`text-xs ${String(selected) === String(opt) ? 'text-white' : 'text-gray-500'} font-medium`}>{opt}</span>
                        </label>
                    ))}
                </div>
            </div>
        );

        // -----------------------------------------------------------------------------
        // Mouse SVG Component
        // -----------------------------------------------------------------------------

        const MouseSVG = ({ showNumbers = false }) => (
            <div className="relative w-48 h-80 mx-auto select-none">
                <svg viewBox="0 0 200 360" className="w-full h-full drop-shadow-2xl">
                    <defs>
                        <linearGradient id="mouseGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stopColor="#2a2a2a" />
                            <stop offset="50%" stopColor="#1a1a1a" />
                            <stop offset="100%" stopColor="#0a0a0a" />
                        </linearGradient>
                        <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                            <feGaussianBlur stdDeviation="3" result="blur" />
                            <feComposite in="SourceGraphic" in2="blur" operator="over" />
                        </filter>
                    </defs>

                    {/* Main Body */}
                    <path
                        d="M50,90 C50,20 150,20 150,90 L150,240 C150,310 50,310 50,240 Z"
                        fill="url(#mouseGrad)"
                        stroke="#111"
                        strokeWidth="1"
                    />

                    {/* Buttons Divider */}
                    <path d="M50,130 L150,130" stroke="#000" strokeWidth="2" />
                    <path d="M100,20 L100,130" stroke="#000" strokeWidth="2" />

                    {/* Scroll Wheel */}
                    <rect x="92" y="55" width="16" height="35" rx="4" fill="#080808" stroke="#333" strokeWidth="1" />
                    <rect x="96" y="60" width="8" height="4" rx="1" fill="#444" />
                    <rect x="96" y="68" width="8" height="4" rx="1" fill="#444" />
                    <rect x="96" y="76" width="8" height="4" rx="1" fill="#444" />

                    {/* LED Indicator */}
                    <circle cx="100" cy="45" r="1.5" fill="cyan" className="animate-pulse">
                        <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite" />
                    </circle>

                    {/* Side Buttons (Left) */}
                    <path d="M48,160 L48,185 C45,185 45,160 48,160" fill="#222" stroke="#111" />
                    <path d="M48,195 L48,220 C45,220 45,195 48,195" fill="#222" stroke="#111" />

                    {/* Logo */}
                    <text x="100" y="260" textAnchor="middle" fill="#333" fontSize="18" fontWeight="bold" fontFamily="sans-serif">X</text>
                </svg>

                {showNumbers && (
                    <>
                        <div className="absolute top-[25%] left-[15%] w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg">1</div>
                        <div className="absolute top-[25%] right-[15%] w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg">2</div>
                        <div className="absolute top-[18%] left-[50%] transform -translate-x-1/2 w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg">3</div>
                        <div className="absolute top-[48%] left-[-8px] w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg">4</div>
                        <div className="absolute top-[58%] left-[-8px] w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg">5</div>
                        <div className="absolute top-[48%] right-[-25px] flex items-center opacity-70">
                            <div className="w-8 h-[1px] border-t border-dashed border-gray-500"></div>
                            <div className="w-5 h-5 bg-gray-600 rounded-full flex items-center justify-center text-white text-[10px] font-bold border border-gray-500 shadow-lg ml-1">6</div>
                        </div>
                    </>
                )}
            </div>
        );

        // -----------------------------------------------------------------------------
        // Sub-Views
        // -----------------------------------------------------------------------------

        const MainView = () => (
            <div className="flex flex-col items-center justify-center h-full animate-[fadeIn_0.5s_ease-out]">
                <div className="transform scale-150">
                    <MouseSVG />
                </div>
            </div>
        );

        const KeyConfigurationView = ({ config, updateConfig }) => {
            const { keyConfig: settings } = config;

            const keys = [
                { id: 1, label: 'Left Click' },
                { id: 2, label: 'Right Click' },
                { id: 3, label: 'Middle Click' },
                { id: 4, label: 'Forward' },
                { id: 5, label: 'Back' },
                { id: 6, label: 'DPI Loop' },
            ];

            return (
                <div className="flex flex-col h-full animate-[slideInRight_0.3s_ease-out]">
                    <div className="flex flex-1 gap-0 px-8 pt-4 pb-0">
                        <div className="flex-1 flex flex-col justify-center gap-2">
                            {keys.map((key) => (
                                <div key={key.id} className="flex items-center gap-4">
                                    <div className="w-6 h-6 rounded-full bg-inputDark border border-gray-700 flex items-center justify-center text-gray-400 text-xs font-bold shadow-inner">
                                        {key.id}
                                    </div>
                                    <div className="flex-1 bg-inputDark rounded px-4 py-2 flex justify-between items-center border border-gray-800 hover:border-gray-600 transition-colors cursor-pointer group shadow-sm">
                                        <span className="text-gray-300 text-xs font-medium">{key.label}</span>
                                        <div className="text-gray-600 group-hover:text-gray-400"><Icons.ChevronDown /></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="flex-1 flex items-center justify-center relative">
                            <div className="transform scale-120">
                                <MouseSVG showNumbers={true} />
                            </div>
                        </div>
                    </div>

                    <div className="border-t border-borderDark bg-[#0d0d0d] px-8 pb-8 pt-0 flex gap-8">
                        <div className="flex-1 bg-panelDark rounded-lg p-5 grid grid-cols-[auto_1fr] gap-x-8 gap-y-4 items-center border border-borderDark shadow-lg">
                            <span className="text-gray-400 text-xs font-medium">Motion Sync</span>
                            <div className="flex justify-end"><ToggleSwitch checked={settings.motionSync} onChange={(v) => updateConfig('motionSync', v)} /></div>

                            <span className="text-gray-400 text-xs font-medium">Debounce Time</span>
                            <div className="flex justify-end w-full">
                                <CustomSelect
                                    value={settings.debounceTime}
                                    options={['0 ms', '2 ms', '4 ms', '8 ms', '16 ms']}
                                    onChange={(v) => updateConfig('debounceTime', v)}
                                />
                            </div>

                            <span className="text-gray-400 text-xs font-medium">Auto Sleep</span>
                            <div className="flex gap-4 items-center justify-end w-full">
                                <ToggleSwitch checked={settings.autoSleep} onChange={(v) => updateConfig('autoSleep', v)} />
                                <div className="w-24">
                                    <CustomSelect
                                        value={settings.sleepTime}
                                        options={['1 min', '5 min', '10 min', 'Never']}
                                        onChange={(v) => updateConfig('sleepTime', v)}
                                        width="w-24"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 bg-panelDark rounded-lg p-5 flex flex-col justify-between border border-borderDark shadow-lg">
                            <span className="text-gray-400 text-xs font-bold mb-2">Current Profile</span>
                            <CustomSelect value={settings.profile} options={['Profile 1 (Onboard)', 'Profile 2', 'Profile 3']} onChange={(v) => updateConfig('profile', v)} />

                            <div className="flex gap-3 mt-4">
                                <button className="flex-1 flex items-center justify-center gap-2 bg-transparent border border-gray-700 hover:border-gray-500 hover:bg-gray-800 text-gray-300 text-xs py-2 rounded transition-all">
                                    Import Config <Icons.Download />
                                </button>
                                <button className="flex-1 flex items-center justify-center gap-2 bg-transparent border border-gray-700 hover:border-gray-500 hover:bg-gray-800 text-gray-300 text-xs py-2 rounded transition-all">
                                    Export Config <Icons.Upload />
                                </button>
                            </div>

                            <button className="w-full flex items-center justify-center gap-2 bg-transparent border border-gray-700 hover:border-gray-500 hover:bg-gray-800 text-gray-300 text-xs py-2 rounded mt-2 transition-all">
                                Factory Reset <Icons.RotateCcw />
                            </button>


                        </div>
                    </div>
                </div>
            );
        };

        const PerformanceView = ({ config, updateConfig }) => {
            const { performance: settings } = config;
            const { dpiStages, dpis, pollingRate, lod, ripple, angleSnapping } = settings;

            // --- Real Hardware Interaction Logic ---

            // Only updates the UI state (Optimistic)
            const handleDpiChange = (id, newValue) => {
                const val = Math.min(26000, Math.max(50, parseInt(newValue) || 50));
                const updatedDpis = dpis.map(d => d.id === id ? { ...d, value: val } : d);
                updateConfig('dpis', updatedDpis);
            };

            // Sends the command to the device (Commit)
            const handleDpiCommit = async (id, newValue) => {
                const val = Math.min(26000, Math.max(50, parseInt(newValue) || 50));
                console.log(`[HID] Committing DPI ${id}: ${val}`);
                try {
                    await WebHIDService.setConfig('motion', `cpi_stage_${id}`, val);
                    const activeDpi = dpis.find(d => d.active);
                    if (activeDpi && activeDpi.id === id) {
                        await WebHIDService.setConfig('motion', 'cpi', val);
                    }
                } catch (e) {
                    console.error("DPI Change Error:", e);
                }
            };

            const toggleDpi = async (id) => {
                const updatedDpis = dpis.map(d => ({ ...d, active: d.id === id }));
                updateConfig('dpis', updatedDpis);

                try {
                    await WebHIDService.setConfig('motion', 'cpi_stage_active', id);
                    const stage = dpis.find(d => d.id === id);
                    if (stage) await WebHIDService.setConfig('motion', 'cpi', stage.value);
                } catch (e) {
                    console.error("Toggle DPI Error:", e);
                }
            }

            const handlePollingRate = async (rate) => {
                updateConfig('pollingRate', rate);
                const val = parseInt(rate);
                try {
                    await WebHIDService.setConfig('motion', 'poll_esb', val);
                    await WebHIDService.setConfig('motion', 'poll_usb', val);
                } catch (e) { console.error("Polling Rate Error", e); }
            };

            const handleLOD = async (valStr) => {
                updateConfig('lod', valStr);
                const val = valStr === '1mm' ? 1 : 2;
                try {
                    await WebHIDService.setConfig('motion', 'lod', val);
                } catch (e) { console.error("LOD Error", e); }
            };

            const handleRipple = async (val) => {
                updateConfig('ripple', val);
                try {
                    await WebHIDService.setConfig('motion', 'ripple_control', val ? 1 : 0);
                } catch (e) { console.error("Ripple Error", e); }
            }

            const handleAngleSnapping = async (val) => {
                updateConfig('angleSnapping', val);
                try {
                    await WebHIDService.setConfig('motion', 'angle_snap', val ? 1 : 0);
                } catch (e) { console.error("Angle Snap Error", e); }
            }

            return (
                <div className="flex flex-col h-full animate-[slideInRight_0.3s_ease-out] px-10 py-8">

                    {/* DPI Header */}
                    <div className="flex justify-between items-center mb-8">
                        <h2 className="text-gray-200 font-bold text-sm">DPI Stage Settings</h2>
                        <div className="flex items-center gap-3">
                        </div>
                    </div>

                    {/* DPI Slider List */}
                    <div className="flex flex-col gap-7 mb-10 flex-1">
                        {dpis.slice(0, dpiStages).map((dpi) => (
                            <div key={dpi.id} className={`flex items-center gap-5 ${!dpi.active ? 'opacity-40 grayscale' : ''} transition-all duration-300`}>
                                {/* Color Indicator/Toggle */}
                                <div
                                    onClick={() => toggleDpi(dpi.id)}
                                    className={`w-4 h-4 rounded-sm cursor-pointer shadow-sm ${dpi.active ? dpi.color : 'bg-gray-700'}`}
                                ></div>

                                <span className="text-gray-400 text-xs w-10 font-medium">DPI {dpi.id}</span>

                                {/* Slider */}
                                <div className="flex-1 relative h-6 flex items-center group">
                                    <input
                                        type="range"
                                        min="50"
                                        max="26000"
                                        step="50"
                                        value={dpi.value}
                                        onChange={(e) => handleDpiChange(dpi.id, e.target.value)}
                                        onMouseUp={(e) => handleDpiCommit(dpi.id, e.target.value)}
                                        onTouchEnd={(e) => handleDpiCommit(dpi.id, e.target.value)}
                                        className="w-full h-[3px] bg-gray-700 rounded-lg appearance-none cursor-pointer outline-none"
                                    />
                                    <span className="absolute left-0 top-5 text-[10px] text-gray-600">50</span>
                                    <span className="absolute right-0 top-5 text-[10px] text-gray-600">26000</span>
                                </div>

                                {/* Input Field */}
                                <input
                                    type="number"
                                    min="50"
                                    max="26000"
                                    step="50"
                                    value={dpi.value}
                                    onChange={(e) => handleDpiChange(dpi.id, e.target.value)}
                                    onBlur={(e) => handleDpiCommit(dpi.id, e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter') {
                                            handleDpiCommit(dpi.id, e.currentTarget.value);
                                            e.currentTarget.blur();
                                        }
                                    }}
                                    className="bg-inputDark border border-gray-700 text-gray-200 text-xs rounded px-2 py-1.5 w-16 text-center focus:outline-none focus:border-gray-500 font-mono"
                                />
                            </div>
                        ))}
                    </div>

                    {/* Bottom Function Area */}
                    <div className="grid grid-cols-2 gap-8 h-40">
                        {/* Polling Rate */}
                        <div className="bg-[#0b0b0b] border border-borderDark rounded-lg p-6 flex flex-col items-center justify-center gap-5 shadow-lg">
                            <span className="text-[#d4d4d4] text-xs font-bold tracking-wide">Polling Rate (Hz)</span>
                            <RadioGroup
                                options={['125', '250', '500', '1000', '2000', '4000']}
                                selected={pollingRate}
                                onChange={handlePollingRate}
                            />
                        </div>

                        {/* LOD & Enhancement Features */}
                        <div className="bg-[#0b0b0b] border border-borderDark rounded-lg p-6 flex items-center justify-between px-8 shadow-lg">
                            <RadioGroup
                                label="LOD"
                                options={['1mm', '2mm']}
                                selected={lod}
                                onChange={handleLOD}
                                layout="vertical"
                            />
                            <div className="h-full w-[1px] bg-gray-800 mx-4"></div>
                            <div className="flex flex-col gap-4">
                                <div className="flex items-center justify-between w-44">
                                    <span className="text-gray-400 text-xs font-medium">Ripple Control</span>
                                    <ToggleSwitch checked={ripple} onChange={handleRipple} />
                                </div>
                                <div className="flex items-center justify-between w-44">
                                    <span className="text-gray-400 text-xs font-medium">Angle Snapping</span>
                                    <ToggleSwitch checked={angleSnapping} onChange={handleAngleSnapping} />
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // Main Application Framework
        // -----------------------------------------------------------------------------

        const App = () => {
            const [activeTab, setActiveTab] = useState('Main');
            const tabs = ['Main', 'Key Configuration', 'Performance'];

            // WebHID State
            const [device, setDevice] = useState(null);
            const [isDongle, setIsDongle] = useState(false);
            const [statusMessage, setStatusMessage] = useState('Mouse not connected.');
            const [isSyncing, setIsSyncing] = useState(false);
            const [batteryLevel, setBatteryLevel] = useState(null); // Initialize as null or 100

            // Shared Configuration State 
            const [config, setConfig] = useState({
                keyConfig: {
                    motionSync: false,
                    debounceTime: '0 ms',
                    autoSleep: false,
                    sleepTime: '1 min',
                    profile: 'Profile 1 (Onboard)'
                },
                performance: {
                    dpiStages: 4,
                    dpis: [
                        { id: 1, color: 'bg-red-600', active: true, value: 400, max: 26000 },
                        { id: 2, color: 'bg-[#00ff00]', active: false, value: 800, max: 26000 },
                        { id: 3, color: 'bg-blue-600', active: false, value: 1600, max: 26000 },
                        { id: 4, color: 'bg-purple-600', active: false, value: 3200, max: 26000 },
                    ],
                    pollingRate: '1000',
                    lod: '1mm',
                    ripple: false,
                    angleSnapping: false,
                }
            });

            // Generic updates for React State
            const updateKeyConfig = useCallback((key, value) => {
                setConfig(prev => ({
                    ...prev,
                    keyConfig: { ...prev.keyConfig, [key]: value }
                }));
            }, []);

            const updatePerformanceConfig = useCallback((key, value) => {
                setConfig(prev => ({
                    ...prev,
                    performance: { ...prev.performance, [key]: value }
                }));
            }, []);

            // --- Sync Logic (Pull from Device) ---
            const fetchSettings = async () => {
                console.log("[App] fetchSettings initiated.");
                try {
                    setIsSyncing(true);
                    setStatusMessage('Syncing settings from mouse...');

                    const MOD_MOTION = 'motion/paw3395';

                    // Helper to log like the Python script
                    const fetchAndLog = async (module, option) => {
                        const val = await WebHIDService.getConfig(module, option);
                        // console.log(`Fetched ${module} ${option}: ${val}`);
                        return val;
                    };

                    // Fetch DPI Stages
                    console.log("[App] Fetching DPI settings...");
                    const stage1 = await fetchAndLog(MOD_MOTION, 'cpi_stage_1');
                    const stage2 = await fetchAndLog(MOD_MOTION, 'cpi_stage_2');
                    const stage3 = await fetchAndLog(MOD_MOTION, 'cpi_stage_3');
                    const stage4 = await fetchAndLog(MOD_MOTION, 'cpi_stage_4');
                    const activeStage = await fetchAndLog(MOD_MOTION, 'cpi_stage_active');

                    // Fetch Current CPI (Added based on logs)
                    const currentCpi = await fetchAndLog(MOD_MOTION, 'cpi');

                    // Fetch other settings
                    console.log("[App] Fetching Performance settings...");
                    const pollRate = await fetchAndLog(MOD_MOTION, 'poll_esb');
                    const lodVal = await fetchAndLog(MOD_MOTION, 'lod');
                    const rippleVal = await fetchAndLog(MOD_MOTION, 'ripple_control');
                    const snapVal = await fetchAndLog(MOD_MOTION, 'angle_snap');

                    // Fetch Battery Level
                    console.log("[App] Fetching Battery level...");
                    const batLevel = await WebHIDService.getConfig('battery_meas', 'bat_level');
                    console.log("[App] batLevel:", batLevel);
                    if (batLevel !== null) {
                        setBatteryLevel(batLevel);
                    }

                    // Update State
                    setConfig(prev => {
                        const newDpis = prev.performance.dpis.map(d => ({ ...d }));
                        if (stage1 !== null) newDpis[0].value = stage1;
                        if (stage2 !== null) newDpis[1].value = stage2;
                        if (stage3 !== null) newDpis[2].value = stage3;
                        if (stage4 !== null) newDpis[3].value = stage4;

                        // Set active
                        if (activeStage !== null) {
                            newDpis.forEach((d, i) => d.active = (i + 1) === activeStage);
                        }

                        console.log("[App] Updating state with new config.");

                        return {
                            ...prev,
                            performance: {
                                ...prev.performance,
                                dpis: newDpis,
                                pollingRate: pollRate !== null ? String(pollRate) : prev.performance.pollingRate,
                                lod: lodVal !== null ? (lodVal === 1 ? '1mm' : '2mm') : prev.performance.lod,
                                ripple: rippleVal === 1,
                                angleSnapping: snapVal === 1
                            }
                        };
                    });
                    setStatusMessage(`Connected: ${WebHIDService.device.productName}`);
                    console.log("[App] Settings Synced Successfully");
                } catch (e) {
                    console.error("[App] Failed to sync settings", e);
                    setStatusMessage('Sync failed. Try reconnecting.');
                } finally {
                    setIsSyncing(false);
                }
            };

            // --- Connection Logic ---

            const pollConnectionStatus = useCallback(async () => {
                if (WebHIDService.isConnecting) return;

                // Check for already paired devices
                const connectedDevice = await WebHIDService.checkConnection();

                if (connectedDevice) {
                    if (!device) {
                        setDevice(connectedDevice.device);
                        setIsDongle(connectedDevice.isDongle);
                        // If we auto-connect, we should also fetch settings
                        fetchSettings();
                    }
                } else {
                    if (device) {
                        setDevice(null);
                        setStatusMessage('Mouse Disconnected.');
                    }
                }
            }, [device]);

            useEffect(() => {
                pollConnectionStatus();
                const intervalId = setInterval(pollConnectionStatus, 5000);
                return () => clearInterval(intervalId);
            }, [pollConnectionStatus]);

            const connectMouse = async () => {
                if (device) {
                    await WebHIDService.disconnect();
                    setDevice(null);
                    setStatusMessage('Disconnected.');
                    return;
                }

                setStatusMessage('Requesting device...');
                WebHIDService.isConnecting = true;
                try {
                    const connectedDevice = await WebHIDService.connect();
                    if (connectedDevice) {
                        // Mimic Python's _read_device_info to verify connection
                        console.log("[App] Reading Device Info...");
                        const boardName = await WebHIDService.getBoardName();
                        const hwid = await WebHIDService.getHWID();

                        console.log(`[App] Board Name: ${boardName}`);
                        console.log(`[App] HWID: ${hwid}`);

                        setDevice(connectedDevice.device);
                        setIsDongle(connectedDevice.isDongle);
                        await fetchSettings(); // Sync immediately after connect
                    }
                } catch (e) {
                    setDevice(null);
                    setStatusMessage(`Connection Error: ${e.message}`);
                } finally {
                    WebHIDService.isConnecting = false;
                }
            };

            const handlePairing = async () => {
                const confirmed = window.confirm("Are you sure you want to enter pairing mode?");
                if (confirmed) {
                    try {
                        console.log("[App] Attempting to start pairing...");
                        await WebHIDService.startPairing();
                        alert('Pairing Request Sent');
                    } catch (e) {
                        console.error("[App] Pairing failed:", e);
                        alert('Pairing Failed: ' + e.message);
                    }
                }
            };

            const isConnected = !!device;
            const connectButtonText = isConnected ? 'Disconnect' : 'Connect Mouse';
            const connectButtonClass = isConnected ? 'bg-statusDanger hover:bg-red-500' : 'bg-statusInfo hover:bg-blue-400';

            return (
                <div className="flex items-center justify-center min-h-screen bg-black font-sans text-gray-100 selection:bg-gray-700 p-8">

                    {/* Window Container */}
                    <div className="w-[900px] h-[640px] bg-panelDark rounded-lg shadow-2xl flex flex-col overflow-hidden border border-borderDark relative ring-1 ring-white/5">

                        {/* Header */}
                        <div className="flex flex-col select-none z-20 bg-panelDark border-b border-borderDark">
                            <div className="h-10 flex items-center justify-between px-6">
                                <div className="flex items-center gap-4">
                                    <div className="text-gray-500 text-lg text-white tracking-widest opacity-90">Hitscan Configurator</div>
                                </div>
                                <div className="flex items-center gap-5">
                                    {isDongle && (
                                        <button
                                            onClick={handlePairing}
                                            className="text-gray-400 hover:text-white cursor-pointer transition-colors p-1"
                                            title="Pair Device"
                                        >
                                            <Icons.Wireless />
                                        </button>
                                    )}
                                    <div className="text-gray-400 hover:text-white cursor-pointer transition-colors"><Icons.Settings /></div>
                                    <div className="text-gray-400 hover:text-white cursor-pointer transition-colors"><Icons.Minus /></div>
                                    <div className="text-gray-400 hover:text-white cursor-pointer transition-colors"><Icons.X /></div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between px-8 h-12">
                                {/* Navigation */}
                                <div className="flex gap-10 h-full">
                                    {tabs.map((tab) => (
                                        <button
                                            key={tab}
                                            onClick={() => setActiveTab(tab)}
                                            className={`h-full flex items-center text-xs font-bold tracking-wide transition-all duration-300 relative ${activeTab === tab ? 'text-white' : 'text-gray-500 hover:text-gray-300'
                                                }`}
                                        >
                                            {tab}
                                            {activeTab === tab && (
                                                <span className="absolute bottom-0 left-0 w-full h-[2px] bg-gray-200 rounded-t-full shadow-[0_0_8px_rgba(255,255,255,0.4)]"></span>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                {/* Controls */}
                                <div className="flex items-center gap-4">
                                    <span className={`text-[10px] ${isSyncing ? 'text-yellow-400' : 'text-gray-500'} max-w-40 text-right truncate`} title={statusMessage}>
                                        {isSyncing ? 'Syncing...' : statusMessage}
                                    </span>

                                    <button
                                        onClick={connectMouse}
                                        className={`text-black text-xs font-bold py-2 px-4 rounded transition-all shadow-md ${connectButtonClass}`}
                                    >
                                        {connectButtonText}
                                    </button>

                                    <div className="flex items-center gap-1.5 text-statusSuccess text-xs font-bold ml-2">
                                        <Icons.Battery />
                                        <span>{batteryLevel !== null ? `${batteryLevel}%` : '---'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Main Content Area */}
                        <div className="flex-1 bg-panelDark relative overflow-hidden">
                            {activeTab === 'Main' && <MainView />}
                            {activeTab === 'Key Configuration' && <KeyConfigurationView config={config} updateConfig={(k, v) => updateKeyConfig(k, v)} />}
                            {activeTab === 'Performance' && <PerformanceView config={config} updateConfig={(k, v) => updatePerformanceConfig(k, v)} />}
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
